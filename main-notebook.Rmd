---
title: "Sistemi di raccomandazione in R"
output: html_notebook
---

### Introduzione
I **sistemi di raccomandazione** sono dei sistemi software che permettono di predire le preferenze di un utente basandoci sulle preferenze espresse dall'utente in passato.  
A differenza dei sistemi tradizionali, essi possono predirre il gradimento dell'utente anche per oggetti rari, evitando il cosidetto fenomeno **long-tail**.  
Un sistema di raccomandazione è strutturato in una matrice chiamata **matrice di utilità**, avente:  
- nelle righe, gli utenti del sistema.  
- nelle colonne, gli oggetti da valutare.  
- nelle celle, la valutazione dell'oggetto nella colonna `j` relativa all'utente nella riga `i`.  

I sistemi di raccomandazione possono diversi in due categorie:  
-  **content-based**: ad ogni utente è associato un profilo che verrà utilizzato per effettuare le predizioni sugli item.  
- **collaborative-filtering**: le predizioni sugli item vengono fatte basandoci su utenti simili (nel caso di **user-based** collaborative filtering) oppure su item simili (nel caso di **item-based** collaborative filtering).  

### Obbiettivo
Creeremo diversi sistemi di raccomandazione e ne confronteremo le prestazioni. Useremo anche un sistema personalizzato che tenga in considerazione delle data in cui è stata lasciata la valutazione.  
Useremo questo [dataset](https://grouplens.org/datasets/movielens/latest/) per generare i sistemi. Al suo interno sono presenti due tabelle `.csv`:  
- `movies.csv`: contiene l'elenco dei film, con i campi `movieId`, `title` e `genres`.  
- `ratings.csv`: contiene l'elenco delle valutazione relative agli utenti, con i campi `userId`, `movieId`, `rating`, `timestamp`.  

### Preparazione dell'ambiente
All'interno del nostro progetto, useremo diverse librerie:  
- [`reshape2`](https://cran.r-project.org/web/packages/reshape2/index.html), permette di creare un data frame oppure una matrice partendo da una lista.  
- [`reccomenderlab`](https://cran.r-project.org/web/packages/recommenderlab/index.html), permette la creazione e la valutazione dei sistemi di raccomandazione.  

Installiamo quindi i pacchetti necessari per il funzionamento:
```{r}
# install.packages("reshape2")
# install.packages("recommenderlab")
```
ed importiamolo nel progetto:
```{r}
library("reshape2")
library("recommenderlab")
```
Adesso, carichiamo i dataset all'interno del progetto usando la funzione `read.csv`:
```{r}
movie_dataset <- read.csv("movie-dataset/movies.csv",  sep = ",")
rating_dataset <- read.csv("movie-dataset/ratings.csv", sep = ",")
```

### Analisi del dataset

Una volta caricati i dati, verifichiamone l'**integrità**.  
L'integrità dei dati è essenziale per garantire l'affidabilità dei risultati dell'analisi.  
La presenza di dati incompleti, come i valori `NA`, potrebbero influenzare la validità dei risultati dell'analisi.  
All'interno di R è presente la funzione `complete.cases` che restituisce una matrice di valori booleani con:  
- TRUE, nel caso in cui i dati sono completi.  
- FALSE, nel caso in cui i dati sono incompleti.  
Questa funzione può essere usata per effettuare una **pulizia** sui dati:  
```{r}
movie_dataset <- movie_dataset[complete.cases(movie_dataset), ]
rating_dataset <- rating_dataset[complete.cases(rating_dataset), ]
```

Dopo aver ottenuto un dataset pulito, possiamo procedere alla creazione della matrice di utilità.  
Essendo il nostro dataset organizzato per righe, è necessario effettuare una conversione.  
Nel pacchetto reshape2 è inclusa la funzione `acast` che prendendo in input le liste di valori, la formula per creare righe / colonne e il nome della lista relativa valore da inserire nelle celle, ci restituisce una matrice.  
Nel nostro caso, `rating_dataset` rappresenta il dataset con tutte le colonne, `userId~movieId`rappresenta la formula per ottenere rispettivamente nelle righe gli utenti e nelle colonne i film, il valore `rating` rappresenta il valore nelle celle.   
Utilizziamola nel nostro caso:
```{r}
converted_matrix <- acast(rating_dataset, userId~movieId, value.var = "rating")
```
Prendiamo i dati migliori:
```{r}
 # rating_dataset <- rating_dataset[nrow(rating_dataset) > 50, ncol(rating_dataset) > 100]
```

Adesso, la possiamo usare come oggetto di tipo `realRatingMatrix`, che reccomenderlab riconosce:
```{r}
rating_matrix <- as(converted_matrix, "realRatingMatrix")
```

Addestramento del sistema, split dei dati:
```{r}
splitted_matrix <- evaluationScheme(rating_matrix, method="split", train=0.8, given=17, goodRating=3, k=3)
```

Di seguito, facciamo l'elenco dei metodi di valutazione che possiamo avere:
```{r}
models_list = list(
  "UBCF:Cosine" = list(name="UBCF", param=list(method ="cosine", normalize="center")),
  "UBCF:Pearson" = list(name="UBCF", param=list(method ="pearson", normalize="center")),
  "IBCF:Cosine" = list(name="IBCF", param=list(method ="cosine", normalize="center")),
  "IBCF:Pearson" = list(name="IBCF", param=list(method ="pearson", normalize="center"))
)
```

Creiamo una funzione per vedere gli errori:
```{r}
get_model_results <- function(params) {
 model <- Recommender(getData(splitted_matrix, "train"), params$name, parameter = params$param)
 test <- predict(model, getData(splitted_matrix, "known"), type="ratings")
 error <- calcPredictionAccuracy(test, getData(splitted_matrix, "unknown"))
 return(error)
}
```

Richiamiamola su tutti i metodi elencati fino ad ora:
```{r}
for (model_name in names(models_list)) {
  params <- models_list[[model_name]]
  model_error <- get_model_results(params)
  models_list[[model_name]] <- c(params, results=model_error)
}
```

Elenchiamo i risultati:
```{r}
for (model_name in names(models_list)) {
  print(paste("Printing results for:", model_name))
  print(paste("RSME:", models_list[[model_name]]$results.RMSE))
  print(paste("MSE:", models_list[[model_name]]$results.MSE))
  print(paste("MAE:", models_list[[model_name]]$results.MAE))
}
```

Vedi altre risorse:  
- [Reccomendation 101](https://www.r-bloggers.com/2014/12/recommender-systems-101-a-step-by-step-practical-example-in-r/)  
- [Data Mania](https://www.data-mania.com/blog/how-to-build-a-recommendation-engine-in-r/)  
- [Res 1](https://rpubs.com/robertwsellers/IS643_Project_2)   
- [Res 2](https://rpubs.com/dhairavc/628480)  
- [Res 3](https://www.linkedin.com/pulse/create-recommendation-engine-using-r-simple-steps-minta-thomas/)  

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
